# Phase 4: 検証機能テスト手順書

## 概要

このドキュメントは、Phase 4で実装されたブロックチェーン記録検証機能のテスト手順を定義します。

**実装日**: 2025-11-12
**対象機能**: Feature 5 (Proof Verification UI)
**テスト範囲**:
- トランザクション検証ロジック (`lib/symbol/verify.ts`)
- 検証ページUI (`app/verify/page.tsx`)
- 確定済みレコードページ (`app/verified/page.tsx`)

---

## テスト環境

### 前提条件

1. **Phase 3の完了**: ブロックチェーンに記録されたトランザクションが存在すること
2. **Symbol Testnetアクセス**: テストネットノードへの接続が可能であること
3. **ブラウザ**: モダンブラウザ（Chrome, Firefox, Edge等）
4. **開発サーバー**: `npm run dev` でアプリケーションが起動していること

### テストデータ準備

Phase 3で作成したトランザクションハッシュを使用します。準備方法:

1. アプリケーションを起動: `npm run dev`
2. 「学習記録」ページで新規レコードを作成
3. 「保留中」ページで作成したレコードをブロックチェーンに登録
4. トランザクションハッシュをコピー（64文字の16進数文字列）

**サンプルハッシュ形式**:
```
3532BA1180E2D12ABD2130488B6CA7EB165D38430202BAF0EC8449A4FF34588D
```

---

## Test Case 1: 検証ロジックの基本動作

### TC1.1: 有効なトランザクションハッシュで検証成功

**目的**: 実際にブロックチェーンに記録されたトランザクションを正常に検証できること

**手順**:
1. Phase 3で作成したトランザクションハッシュを準備
2. ブラウザで `http://localhost:3000/verify` にアクセス
3. トランザクションハッシュ入力欄にハッシュを貼り付け
4. 「検証する」ボタンをクリック

**期待結果**:
- ✅ 「検証成功」の緑色のメッセージが表示される
- ✅ トランザクションハッシュが表示される
- ✅ ブロック高が数値で表示される（例: 1,234,567）
- ✅ 署名者アドレスが表示される（40文字の16進数）
- ✅ タイムスタンプが日本語形式で表示される（例: 2025/11/12 15:30:45）
- ✅ メッセージ内容がJSONフォーマットで表示される
- ✅ 検証詳細セクションに3つの緑色チェックマークが表示される:
  - トランザクションが見つかりました
  - メッセージがデコードされました
  - ブロックで確認されました
- ✅ "Symbol Explorerで確認"リンクが表示される

**デバッグログ確認**:
ブラウザの開発者ツールコンソールで以下のログが出力されることを確認:
```
🔍 [DEBUG] verifyTransaction 開始
🔍 [DEBUG] txHash: <ハッシュ>
🔍 [DEBUG] トランザクション情報取得開始
🔍 [DEBUG] response.status: 200
🔍 [DEBUG] メッセージデコード開始
🔍 [DEBUG] decoded message: {...}
🔍 [DEBUG] 検証成功
```

---

### TC1.2: 存在しないトランザクションハッシュで検証失敗

**目的**: 存在しないハッシュで適切なエラーメッセージが表示されること

**手順**:
1. ブラウザで `http://localhost:3000/verify` にアクセス
2. 以下の存在しないハッシュを入力:
   ```
   0000000000000000000000000000000000000000000000000000000000000000
   ```
3. 「検証する」ボタンをクリック

**期待結果**:
- ✅ 「検証失敗」の赤色のメッセージが表示される
- ✅ エラーメッセージ: "指定されたトランザクションが見つかりませんでした" が表示される
- ✅ 詳細情報セクションは表示されない

**デバッグログ確認**:
```
🔍 [DEBUG] トランザクションが見つかりません (404)
🔍 [DEBUG] トランザクションが見つからない
```

---

### TC1.3: 無効な形式のハッシュで検証失敗

**目的**: 形式が正しくないハッシュで適切なバリデーションエラーが表示されること

**テストケース**:

**TC1.3.1: 短すぎるハッシュ**
- 入力: `ABC123`
- 期待結果: "無効なトランザクションハッシュです（64文字の16進数である必要があります）"

**TC1.3.2: 長すぎるハッシュ**
- 入力: `3532BA1180E2D12ABD2130488B6CA7EB165D38430202BAF0EC8449A4FF34588D0000`
- 期待結果: "無効なトランザクションハッシュです（64文字の16進数である必要があります）"

**TC1.3.3: 16進数以外の文字を含む**
- 入力: `3532BA1180E2D12ABD2130488B6CA7EB165D38430202BAF0EC8449A4FF34588G`
- 期待結果: "無効なトランザクションハッシュです（64文字の16進数である必要があります）"

**TC1.3.4: 空文字列**
- 入力: （空欄）
- 期待結果: 「検証する」ボタンが無効化され、クリックできない

---

## Test Case 2: 検証ページUIの動作確認

### TC2.1: URLパラメータからの自動検証

**目的**: URLにハッシュが含まれる場合、自動的に検証が実行されること

**手順**:
1. 有効なトランザクションハッシュを準備
2. ブラウザで以下のURLに直接アクセス:
   ```
   http://localhost:3000/verify?hash=<トランザクションハッシュ>
   ```

**期待結果**:
- ✅ ページロード時に自動的に検証が開始される
- ✅ 入力欄にハッシュが自動入力される
- ✅ 検証結果が表示される
- ✅ 「検証中...」の表示が一瞬表示された後、結果が表示される

**デバッグログ確認**:
```
🔍 [DEBUG] URLからハッシュを取得: <ハッシュ>
🔍 [DEBUG] verifyFromHash 開始: <ハッシュ>
```

---

### TC2.2: クリアボタンの動作

**目的**: クリアボタンで入力と結果がリセットされること

**手順**:
1. 検証ページで有効なハッシュを入力して検証実行
2. 検証結果が表示された状態で「クリア」ボタンをクリック

**期待結果**:
- ✅ 入力欄が空になる
- ✅ 検証結果セクションが非表示になる
- ✅ 使い方ガイドセクションが再表示される

---

### TC2.3: 検証中のUI状態

**目的**: 検証処理中に適切なローディング状態が表示されること

**手順**:
1. 検証ページで有効なハッシュを入力
2. 「検証する」ボタンをクリック
3. 検証処理中のUI状態を観察

**期待結果**:
- ✅ ボタンのラベルが「検証中...」に変わる
- ✅ ボタンが無効化される（グレーアウト）
- ✅ 入力欄が無効化される
- ✅ クリアボタンが無効化される
- ✅ 検証完了後、すべての要素が有効化される

---

### TC2.4: Symbol Explorerリンクの動作

**目的**: 外部リンクが正しく動作すること

**手順**:
1. 有効なハッシュで検証を実行
2. 検証結果セクションの「Symbol Explorerで確認」リンクをクリック

**期待結果**:
- ✅ 新しいタブで Symbol Explorer が開く
- ✅ URLが正しい形式である:
  - Testnet: `https://testnet.symbol.fyi/transactions/<ハッシュ>`
  - Mainnet: `https://mainnet.symbol.fyi/transactions/<ハッシュ>`
- ✅ Symbol Explorer上でトランザクション詳細が表示される

---

## Test Case 3: 確定済みレコードページの動作確認

### TC3.1: 確定済みレコード一覧の表示

**目的**: LocalStorageに保存された確定済みレコードが正しく表示されること

**前提条件**:
- Phase 3でブロックチェーンに記録したレコードが1件以上存在すること

**手順**:
1. ブラウザで `http://localhost:3000/verified` にアクセス

**期待結果**:
- ✅ ページタイトル「確定済みレコード」が表示される
- ✅ 統計情報カードが3つ表示される:
  - 合計: 確定済みレコードの総数
  - 検証済み: 検証済みフラグがtrueのレコード数
  - 未検証: 検証済みフラグがfalseのレコード数
- ✅ レコード一覧が表示される
- ✅ 各レコードに以下の情報が表示される:
  - 学習記録の基本情報（タイトル、科目、学習時間など）
  - トランザクションハッシュ（モノスペースフォント）
  - ブロック高（カンマ区切り数値）
  - 検証ステータス（✓検証済み または ○未検証）

**デバッグログ確認**:
```
🔍 [DEBUG] loadData 開始
🔍 [DEBUG] confirmedRecords: [...]
```

---

### TC3.2: 統計情報の正確性

**目的**: 統計カードの数値が正しく計算されていること

**手順**:
1. 確定済みレコードページにアクセス
2. LocalStorageの内容を確認（開発者ツール > Application > Local Storage）
3. 統計カードの数値を確認

**期待結果**:
- ✅ 合計 = LocalStorageに保存されている `confirmedRecords` の配列長
- ✅ 検証済み = `verified: true` のレコード数
- ✅ 未検証 = 合計 - 検証済み

**検証方法**:
```javascript
// ブラウザコンソールで実行
const records = JSON.parse(localStorage.getItem('confirmedRecords') || '[]');
const total = records.length;
const verified = records.filter(r => r.verified).length;
const unverified = total - verified;
console.log({ total, verified, unverified });
```

---

### TC3.3: 検証ページへのリンク動作

**目的**: 各レコードから検証ページへ正しく遷移できること

**手順**:
1. 確定済みレコードページにアクセス
2. 任意のレコードの「検証ページで確認」ボタンをクリック

**期待結果**:
- ✅ 検証ページ (`/verify`) に遷移する
- ✅ URLにトランザクションハッシュが含まれる: `/verify?hash=<ハッシュ>`
- ✅ 検証ページで自動的に検証が実行される
- ✅ 検証結果が表示される

---

### TC3.4: Symbol Explorerリンクの動作

**目的**: 各レコードから Symbol Explorer への外部リンクが動作すること

**手順**:
1. 確定済みレコードページにアクセス
2. 任意のレコードの「Explorer」ボタンをクリック

**期待結果**:
- ✅ 新しいタブで Symbol Explorer が開く
- ✅ 正しいトランザクション詳細ページが表示される

---

### TC3.5: 空状態の表示

**目的**: 確定済みレコードが0件の場合、適切なメッセージが表示されること

**前提条件**:
- LocalStorageから `confirmedRecords` を削除
  ```javascript
  localStorage.removeItem('confirmedRecords');
  ```

**手順**:
1. ブラウザをリフレッシュ
2. 確定済みレコードページにアクセス

**期待結果**:
- ✅ 統計カードがすべて `0` を表示
- ✅ 空状態メッセージが表示される:
  - "確定済みレコードがありません。保留中レコードをブロックチェーンに登録してください。"
- ✅ ヘルプセクションが表示される（青色の情報ボックス）

---

## Test Case 4: 統合テスト（Phase 3 → Phase 4連携）

### TC4.1: エンドツーエンド: レコード作成→登録→検証

**目的**: 学習記録の作成からブロックチェーン検証までの全フローが正常に動作すること

**手順**:

1. **レコード作成**:
   - `http://localhost:3000/` にアクセス
   - 新規学習記録を作成（例: 「データベース設計」、科目「情報工学」、90分）
   - 保存ボタンをクリック

2. **ブロックチェーン登録**:
   - 「保留中」ページに移動
   - 作成したレコードの「ブロックチェーンに登録」ボタンをクリック
   - SSS Extensionで署名して送信
   - トランザクションハッシュをコピー

3. **待機**:
   - 30秒～2分程度待機（ブロック承認まで）

4. **確定済みレコード確認**:
   - 「確定済み」ページをリロード
   - 登録したレコードが表示されることを確認

5. **検証実行**:
   - 「検証ページで確認」ボタンをクリック
   - 検証結果を確認

**期待結果**:
- ✅ 各ステップでエラーが発生しない
- ✅ 保留中レコードが確定済みレコードに移行する
- ✅ 検証ページで正常に検証成功が表示される
- ✅ メッセージ内容が作成時のレコード内容と一致する

---

### TC4.2: LocalStorage整合性確認

**目的**: Phase 3で作成したデータとPhase 4の検証結果が整合していること

**手順**:
1. Phase 3でブロックチェーンに登録したレコードを確定済みページで表示
2. そのレコードを検証ページで検証
3. LocalStorageのデータと検証結果を比較

**期待結果**:
- ✅ LocalStorageの `title` と検証結果のメッセージ内の `title` が一致
- ✅ LocalStorageの `subject` と検証結果のメッセージ内の `subject` が一致
- ✅ LocalStorageの `duration` と検証結果のメッセージ内の `duration` が一致
- ✅ LocalStorageの `date` と検証結果のメッセージ内の `date` が一致
- ✅ トランザクションハッシュが一致

**検証方法**:
```javascript
// ブラウザコンソールで実行
const confirmedRecords = JSON.parse(localStorage.getItem('confirmedRecords') || '[]');
console.log('LocalStorage:', confirmedRecords[0]);
// 検証ページのメッセージ内容と比較
```

---

## Test Case 5: エラーハンドリングとエッジケース

### TC5.1: ネットワークエラー時の動作

**目的**: ノードに接続できない場合の適切なエラーメッセージ表示

**手順**:
1. `.env.local` のノードURLを無効なURLに変更:
   ```
   NEXT_PUBLIC_SYMBOL_NODE_URL=http://invalid-node.example.com:3000
   ```
2. 開発サーバーを再起動: `npm run dev`
3. 検証ページで有効なハッシュを入力して検証実行

**期待結果**:
- ✅ 「検証失敗」メッセージが表示される
- ✅ エラー詳細にネットワークエラーの情報が含まれる

**後処理**:
- `.env.local` を元の正しいノードURLに戻す
- 開発サーバーを再起動

---

### TC5.2: Transfer Transaction以外のトランザクション

**目的**: TransferTransaction以外のトランザクションタイプで適切にエラーが表示されること

**注**: このテストは実際のトランザクションが必要なため、記録のみ

**期待動作**:
- Aggregate Transaction、Multisig Transaction等、非TransferTransactionの場合
- `lib/symbol/verify.ts:188` で `tx.type !== 16724` の条件に該当
- "トランザクションが見つかりませんでした"エラーが返される

---

### TC5.3: メッセージが暗号化されている場合

**目的**: 暗号化メッセージの場合の適切なエラーハンドリング

**注**: このテストは実際のトランザクションが必要なため、記録のみ

**期待動作**:
- メッセージタイプが `0x00` (plain) 以外の場合
- `lib/symbol/verify.ts:235` で `messageType !== '00'` の条件に該当
- メッセージデコード失敗として処理される
- 検証結果の `details.messageDecoded` が `false` になる

---

### TC5.4: 非JSON形式のメッセージ

**目的**: メッセージがJSONパース不可能な場合のエラーハンドリング

**注**: このテストは実際のトランザクションが必要なため、記録のみ

**期待動作**:
- メッセージが有効なJSON形式でない場合
- `JSON.parse()` が失敗し、`decodeMessage()` が `null` を返す
- 検証結果の `message` が `null` になる
- 検証結果の `details.messageDecoded` が `false` になる

---

## Test Case 6: レスポンシブデザイン確認

### TC6.1: モバイルビューでの表示

**目的**: スマートフォン画面サイズでUIが適切に表示されること

**手順**:
1. ブラウザの開発者ツールを開く
2. デバイスエミュレーション（例: iPhone 12 Pro）を有効化
3. 検証ページと確定済みページを表示

**期待結果（検証ページ）**:
- ✅ 入力欄が画面幅いっぱいに表示される
- ✅ ボタンが縦並び（flex-col）またはフルワイド表示
- ✅ トランザクションハッシュが折り返して表示される（`break-all`）
- ✅ 検証結果の各カードが縦並びになる（`grid-cols-1`）

**期待結果（確定済みページ）**:
- ✅ 統計カードが縦並びになる（`grid-cols-1`）
- ✅ レコード一覧が縦スクロール可能
- ✅ アクションボタンが適切なサイズで表示される

---

### TC6.2: タブレットビューでの表示

**手順**:
1. デバイスエミュレーション（例: iPad）を有効化
2. 各ページを表示

**期待結果**:
- ✅ 統計カードが横並び（`md:grid-cols-3`）
- ✅ レコード詳細が2カラム表示（`md:grid-cols-2`）

---

## Test Case 7: ダークモード対応確認

### TC7.1: ダークモード切り替え

**目的**: ダークモードで適切なカラースキームが適用されること

**手順**:
1. OSまたはブラウザのダークモード設定を有効化
2. 検証ページと確定済みページを表示

**期待結果（検証ページ）**:
- ✅ 背景が暗い色（`dark:bg-gray-800`）
- ✅ テキストが明るい色（`dark:text-gray-100`）
- ✅ 入力欄の背景が暗い色（`dark:bg-gray-700`）
- ✅ ボーダー色が調整される（`dark:border-gray-600`）
- ✅ 成功/失敗メッセージの背景色が暗い色（`dark:bg-green-900/20`等）

**期待結果（確定済みページ）**:
- ✅ 統計カードの背景が暗い色
- ✅ レコード一覧の背景が暗い色
- ✅ すべてのテキストが読みやすいコントラスト

---

## Test Case 8: パフォーマンステスト

### TC8.1: 大量レコード表示時のパフォーマンス

**目的**: 100件以上の確定済みレコードでも快適に動作すること

**注**: このテストは大量のテストデータが必要なため、将来的な実施項目

**手順**:
1. LocalStorageに100件の確定済みレコードを挿入（スクリプト使用）
2. 確定済みページを表示
3. スクロールとフィルタリングの動作を確認

**期待結果**:
- ✅ ページロードが3秒以内
- ✅ スクロールが滑らか
- ✅ 統計計算が即座に完了

---

### TC8.2: 検証APIのレスポンスタイム

**目的**: 検証処理が許容範囲内の時間で完了すること

**手順**:
1. 検証ページで有効なハッシュを検証
2. ブラウザの開発者ツール > Network タブでAPIリクエストを確認

**期待結果**:
- ✅ `/transactions/confirmed/{hash}` へのリクエストが5秒以内に完了
- ✅ 検証結果の表示が6秒以内

---

## Test Case 9: セキュリティ確認

### TC9.1: XSS対策

**目的**: ユーザー入力がサニタイズされていること

**手順**:
1. 検証ページで以下のハッシュを入力:
   ```
   <script>alert('XSS')</script>000000000000000000000000000000
   ```
2. 検証実行

**期待結果**:
- ✅ スクリプトが実行されない
- ✅ バリデーションエラーが表示される（16進数以外の文字を含む）

---

### TC9.2: LocalStorage改ざん検知

**目的**: LocalStorageのデータが改ざんされても、ブロックチェーン検証で真実が確認できること

**手順**:
1. LocalStorageの `confirmedRecords` を直接編集:
   ```javascript
   const records = JSON.parse(localStorage.getItem('confirmedRecords') || '[]');
   records[0].title = "改ざんされたタイトル";
   localStorage.setItem('confirmedRecords', JSON.stringify(records));
   ```
2. 確定済みページをリロード（改ざんされたデータが表示される）
3. そのレコードを検証ページで検証

**期待結果**:
- ✅ LocalStorageには改ざんされたタイトルが表示される
- ✅ 検証ページでは元の正しいタイトルが表示される
- ✅ これによりブロックチェーンが改ざん不可能であることが証明される

---

## テスト実施チェックリスト

以下のチェックリストを使用して、すべてのテストケースが実施されたことを確認してください。

### 基本機能
- [ ] TC1.1: 有効なトランザクションハッシュで検証成功
- [ ] TC1.2: 存在しないトランザクションハッシュで検証失敗
- [ ] TC1.3.1～1.3.4: 無効な形式のハッシュでバリデーションエラー

### 検証ページUI
- [ ] TC2.1: URLパラメータからの自動検証
- [ ] TC2.2: クリアボタンの動作
- [ ] TC2.3: 検証中のUI状態
- [ ] TC2.4: Symbol Explorerリンクの動作

### 確定済みレコードページ
- [ ] TC3.1: 確定済みレコード一覧の表示
- [ ] TC3.2: 統計情報の正確性
- [ ] TC3.3: 検証ページへのリンク動作
- [ ] TC3.4: Symbol Explorerリンクの動作
- [ ] TC3.5: 空状態の表示

### 統合テスト
- [ ] TC4.1: エンドツーエンド（レコード作成→登録→検証）
- [ ] TC4.2: LocalStorage整合性確認

### エラーハンドリング
- [ ] TC5.1: ネットワークエラー時の動作
- [ ] TC5.2～5.4: エッジケース（記録のみ）

### UI/UX
- [ ] TC6.1: モバイルビューでの表示
- [ ] TC6.2: タブレットビューでの表示
- [ ] TC7.1: ダークモード対応

### その他
- [ ] TC9.1: XSS対策
- [ ] TC9.2: LocalStorage改ざん検知

---

## テスト実施記録

### テスト実施日: YYYY-MM-DD
### テスト実施者: _______________

| テストケース | 結果 | 備考 |
|------------|------|------|
| TC1.1      | ☐ Pass / ☐ Fail | |
| TC1.2      | ☐ Pass / ☐ Fail | |
| TC1.3.1    | ☐ Pass / ☐ Fail | |
| TC1.3.2    | ☐ Pass / ☐ Fail | |
| TC1.3.3    | ☐ Pass / ☐ Fail | |
| TC1.3.4    | ☐ Pass / ☐ Fail | |
| TC2.1      | ☐ Pass / ☐ Fail | |
| TC2.2      | ☐ Pass / ☐ Fail | |
| TC2.3      | ☐ Pass / ☐ Fail | |
| TC2.4      | ☐ Pass / ☐ Fail | |
| TC3.1      | ☐ Pass / ☐ Fail | |
| TC3.2      | ☐ Pass / ☐ Fail | |
| TC3.3      | ☐ Pass / ☐ Fail | |
| TC3.4      | ☐ Pass / ☐ Fail | |
| TC3.5      | ☐ Pass / ☐ Fail | |
| TC4.1      | ☐ Pass / ☐ Fail | |
| TC4.2      | ☐ Pass / ☐ Fail | |
| TC5.1      | ☐ Pass / ☐ Fail | |
| TC6.1      | ☐ Pass / ☐ Fail | |
| TC6.2      | ☐ Pass / ☐ Fail | |
| TC7.1      | ☐ Pass / ☐ Fail | |
| TC9.1      | ☐ Pass / ☐ Fail | |
| TC9.2      | ☐ Pass / ☐ Fail | |

### 総合評価
- **Pass**: _____ 件
- **Fail**: _____ 件
- **成功率**: _____ %

### 発見された問題
1.
2.
3.

### 改善提案
1.
2.
3.

---

## 参考資料

- **実装仕様**: `.kiro/specs/proof-verification-feature/SPEC.md`
- **Phase 3テスト**: `docs/tests/phase-3-transaction-test.md`
- **デバッグログ**: `docs/logs/phase-3-debugging-log.md`
- **Symbol REST API**: https://docs.symbol.dev/api.html
- **Symbol Explorer**: https://testnet.symbol.fyi/

---

**Document Version**: 1.0
**Last Updated**: 2025-11-12
